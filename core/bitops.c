#include "deciphon/bitops.h"

unsigned bitops_fls32(uint32_t x)
{

#if __has_builtin(__builtin_clz)
    return (unsigned)((int)sizeof(int) * 8 - __builtin_clz(x));
#else
    unsigned r = 32;

    if (!(x & 0xffff0000u))
    {
        x <<= 16;
        r -= 16;
    }
    if (!(x & 0xff000000u))
    {
        x <<= 8;
        r -= 8;
    }
    if (!(x & 0xf0000000u))
    {
        x <<= 4;
        r -= 4;
    }
    if (!(x & 0xc0000000u))
    {
        x <<= 2;
        r -= 2;
    }
    if (!(x & 0x80000000u))
    {
        x <<= 1;
        r -= 1;
    }
    return r;
#endif
}

int bitops_fful(unsigned long word)
{
#if __has_builtin(__builtin_ffsl)
    return __builtin_ffsl((long)word) - 1;
#else
    int num = 0;

#if SIZE_BITS_PER_LONG == 64
    if ((word & 0xffffffff) == 0)
    {
        num += 32;
        word >>= 32;
    }
#endif
    if ((word & 0xffff) == 0)
    {
        num += 16;
        word >>= 16;
    }
    if ((word & 0xff) == 0)
    {
        num += 8;
        word >>= 8;
    }
    if ((word & 0xf) == 0)
    {
        num += 4;
        word >>= 4;
    }
    if ((word & 0x3) == 0)
    {
        num += 2;
        word >>= 2;
    }
    if ((word & 0x1) == 0) num += 1;
    return num;
#endif
}
